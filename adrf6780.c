// SPDX-License-Identifier: GPL-2.0+
/*
 * ADRF6780 driver
 *
 * Copyright 2021 Analog Devices Inc.
 */

#include <linux/bitfield.h>
#include <linux/bits.h>
#include <linux/clk.h>
#include <linux/clkdev.h>
#include <linux/clk/clkscale.h>
#include <linux/clk-provider.h>
#include <linux/device.h>
#include <linux/iio/iio.h>
#include <linux/module.h>
#include <linux/notifier.h>
#include <linux/regmap.h>
#include <linux/spi/spi.h>

#include <linux/iio/sysfs.h>

/* ADRF6780 Register Map */
#define ADRF6780_REG_CONTROL			0x00
#define ADRF6780_REG_ALARM_READBACK		0x01
#define ADRF6780_REG_ALARM_MASKS		0x02
#define ADRF6780_REG_ENABLE			0x03
#define ADRF6780_REG_LINEARIZE			0x04
#define ADRF6780_REG_LO_PATH			0x05
#define ADRF6780_REG_ADC_CONTROL 		0x06
#define ADRF6780_REG_ADC_OUTPUT			0x0C

/* ADRF6780_REG_CONTROL Map */
#define ADRF6780_PARITY_EN_MSK       		BIT(15)
#define ADRF6780_PARITY_EN(x)			FIELD_PREP(ADRF6780_PARITY_EN_MSK, x)
#define ADRF6780_SOFT_RESET_MSK			BIT(14)
#define ADRF6780_SOFT_RESET(x)         		FIELD_PREP(ADRF6780_SOFT_RESET_MSK, x)
#define ADRF6780_CHIP_ID_MSK			GENMASK(11, 4)
#define ADRF6780_CHIP_ID             		0xA
#define ADRF6780_CHIP_REVISION_MSK		GENMASK(3, 0)
#define ADRF6780_CHIP_REVISION(x)        	FIELD_PREP(ADRF6780_CHIP_REVISION_MSK, x)


/* ADRF6780_REG_ALARM_READBACK Map */
#define ADRF6780_PARITY_ERROR_MSK       	BIT(15)
#define ADRF6780_PARITY_ERROR(x)         	FIELD_PREP(ADRF6780_PARITY_ERROR_MSK, x)
#define ADRF6780_TOO_FEW_ERRORS_MSK		BIT(14)
#define ADRF6780_TOO_FEW_ERRORS(x)         	FIELD_PREP(ADRF6780_TOO_FEW_ERRORS_MSK, x)
#define ADRF6780_TOO_MANY_ERRORS_MSK		BIT(13)
#define ADRF6780_TOO_MANY_ERRORS(x)         	FIELD_PREP(ADRF6780_TOO_MANY_ERRORS_MSK, x)
#define ADRF6780_ADDRESS_RANGE_ERROR_MSK	BIT(12)
#define ADRF6780_ADDRESS_RANGE_ERROR(x)         FIELD_PREP(ADRF6780_ADDRESS_RANGE_ERROR_MSK, x)

/* ADRF6780_REG_ENABLE Map */
#define ADRF6780_VGA_BUFFER_EN_MSK     		BIT(8)
#define ADRF6780_VGA_BUFFER_EN(x)      		FIELD_PREP(ADRF6780_VGA_BUFFER_EN_MSK, x)
#define ADRF6780_DETECTOR_EN_MSK       		BIT(7)
#define ADRF6780_DETECTOR_EN(x)         	FIELD_PREP(ADRF6780_DETECTOR_EN_MSK, x)
#define ADRF6780_LO_BUFFER_EN_MSK		BIT(6)
#define ADRF6780_LO_BUFFER_EN(x)         	FIELD_PREP(ADRF6780_LO_BUFFER_EN_MSK, x)
#define ADRF6780_IF_MODE_EN_MSK			BIT(5)
#define ADRF6780_IF_MODE_EN(x)         		FIELD_PREP(ADRF6780_IF_MODE_EN_MSK, x)
#define ADRF6780_IQ_MODE_EN_MSK			BIT(4)
#define ADRF6780_IQ_MODE_EN(x)         		FIELD_PREP(ADRF6780_IQ_MODE_EN_MSK, x)
#define ADRF6780_LO_X2_EN_MSK			BIT(3)
#define ADRF6780_LO_X2_EN(x)       		FIELD_PREP(ADRF6780_LO_X2_EN_MSK, x)
#define ADRF6780_LO_PPF_EN_MSK			BIT(2)
#define ADRF6780_LO_PPF_EN(x)         		FIELD_PREP(ADRF6780_LO_PPF_EN_MSK, x)
#define ADRF6780_LO_EN_MSK			BIT(1)
#define ADRF6780_LO_EN(x)         		FIELD_PREP(ADRF6780_LO_EN_MSK, x)
#define ADRF6780_UC_BIAS_EN_MSK			BIT(0)
#define ADRF6780_UC_BIAS_EN(x)         		FIELD_PREP(ADRF6780_UC_BIAS_EN_MSK, x)

/* ADRF6780_REG_LINEARIZE Map */
#define ADRF6780_RDAC_LINEARIZE_MSK     	GENMASK(7, 0)
#define ADRF6780_RDAC_LINEARIZE(x)      	FIELD_PREP(ADRF6780_RDAC_LINEARIZE_MSK, x)

/* ADRF6780_REG_LO_PATH Map */
#define ADRF6780_LO_SIDEBAND_MSK     		BIT(10)
#define ADRF6780_LO_SIDEBAND(x)      		FIELD_PREP(ADRF6780_LO_SIDEBAND_MSK, x)
#define ADRF6780_Q_PATH_PHASE_ACCURACY_MSK     	GENMASK(7, 4)
#define ADRF6780_Q_PATH_PHASE_ACCURACY(x)  	FIELD_PREP(ADRF6780_Q_PATH_PHASE_ACCURACY_MSK, x)
#define ADRF6780_I_PATH_PHASE_ACCURACY_MSK     	GENMASK(3, 0)
#define ADRF6780_I_PATH_PHASE_ACCURACY(x)      	FIELD_PREP(ADRF6780_I_PATH_PHASE_ACCURACY_MSK, x)

/* ADRF6780_REG_ADC_CONTROL Map */
#define ADRF6780_VDET_OUTPUT_SELECT_MSK    	BIT(3)
#define ADRF6780_VDET_OUTPUT_SELECT(x)     	FIELD_PREP(ADRF6780_VDET_OUTPUT_SELECT_MSK, x)
#define ADRF6780_ADC_START_MSK     		BIT(2)
#define ADRF6780_ADC_START(x)      		FIELD_PREP(ADRF6780_ADC_START_MSK, x)
#define ADRF6780_ADC_EN_MSK     		BIT(1)
#define ADRF6780_ADC_EN(x)  			FIELD_PREP(ADRF6780_ADC_EN_MSK, x)
#define ADRF6780_ADC_CLOCK_EN_MSK     		BIT(0)
#define ADRF6780_ADC_CLOCK_EN(x)      		FIELD_PREP(ADRF6780_ADC_CLOCK_EN_MSK, x)

/* ADRF6780_REG_ADC_OUTPUT Map */
#define ADRF6780_ADC_STATUS_MSK     		BIT(1)
#define ADRF6780_ADC_STATUS(x)  		FIELD_PREP(ADRF6780_ADC_STATUS_MSK, x)
#define ADRF6780_ADC_VALUE_MSK     		GENMASK(7, 0)
#define ADRF6780_ADC_VALUE(x)      		FIELD_PREP(ADRF6780_ADC_VALUE_MSK, x)

MODULE_AUTHOR("Antoniu Miclaus <antoniu.miclaus@analog.com");
MODULE_DESCRIPTION("Analog Devices ADRF6780");
MODULE_LICENSE("GPL v2");

